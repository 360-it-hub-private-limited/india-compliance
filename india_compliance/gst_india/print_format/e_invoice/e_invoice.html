<style>
    {% include "india_compliance/gst_india/print_format/e_invoice/e_invoice.css" %}
</style>

{%- from "templates/print_formats/standard_macros.html" import add_header, render_field, print_value -%}

{% set e_invoice_log = frappe.db.get_value(
	"e-Invoice Log", doc.irn, ("invoice_data", "signed_qr_code"), as_dict=True
) %}

{%- set invoice_data = _dict(json.loads(e_invoice_log.invoice_data)) -%}

<div class="page-break">
	<div {% if print_settings.repeat_header_footer %} id="header-html" class="hidden-pdf" {% endif %}>
		{% if letter_head and not no_letterhead %}
			<div class="letter-head">{{ letter_head }}</div>
		{% endif %}
		<div class="print-heading text-right">
			<h2>e-Invoice<br><small>{{ doc.name }}</small></h2>
		</div>
	</div>
	{% if print_settings.repeat_header_footer %}
	<div id="footer-html" class="visible-pdf">
		{% if not no_letterhead and footer %}
		<div class="letter-head-footer">
			{{ footer }}
		</div>
		{% endif %}
		<p class="text-center small page-number visible-pdf">
			{{ _("Page {0} of {1}").format('<span class="page"></span>', '<span class="topage"></span>') }}
		</p>
	</div>
	{% endif %}
	<h5 class="font-bold section-heading">1. Transaction Details</h5>
	<div class="row section-break info-section">
		<div class="col-xs-8 column-break">
			{%
				set transaction_details = {
					"IRN": invoice_data.Irn,
					"Ack. No": invoice_data.AckNo,
					"Ack. Date": frappe.utils.format_datetime(invoice_data.AckDt, "dd/MM/yyyy hh:mm:ss"),
					"Category": invoice_data.TranDtls.SupTyp,
					"Document Type": invoice_data.DocDtls.Typ,
					"Document No": invoice_data.DocDtls.No,
				}
			%}
			{% for key, value in transaction_details.items() %}
				<div class="row data-field">
					<div class="col-xs-4"><label>{{ key }}</label></div>
					<div class="col-xs-8 value">{{ value }}</div>
				</div>
			{% endfor %}
		</div>
		<div class="col-xs-4 column-break">
			<img src="data:image/png;base64,{{ get_qr_code(e_invoice_log.signed_qr_code, scale=2) }}" width="175px" style="float: right;">
		</div>
	</div>
	<h5 class="font-bold section-heading">2. Party Details</h5>
	<div class="row section-break info-section">
		<div class="col-xs-6 column-break">
			{%- set diff_dispatch_addr = invoice_data.DispDtls and (invoice_data.DispDtls.Pin != invoice_data.SellerDtls.Pin or invoice_data.DispDtls.Addr1 != invoice_data.SellerDtls.Addr1) -%}
			<h5 style="margin-bottom: 5px;"><strong>
				{% if diff_dispatch_addr %}
					Seller Details
				{% else %}
					Seller and Dispatch Details
				{% endif %}
			</strong></h5>
			{{ get_address_html(invoice_data.SellerDtls) }}

			{%- if diff_dispatch_addr -%}
			<h5 style="margin-bottom: 5px;"><strong>Dispatched From</strong></h5>
				{{ get_address_html(invoice_data.DispDtls) }}
			{% endif %}
		</div>
		<div class="col-xs-6 column-break">
			{%- set diff_shipping_addr = invoice_data.ShipDtls and (invoice_data.ShipDtls.Pin != invoice_data.BuyerDtls.Pin or invoice_data.ShipDtls.Addr1 != invoice_data.BuyerDtls.Addr1) -%}
			<h5 style="margin-bottom: 5px;"><strong>
				{% if diff_shipping_addr %}
					Buyer Details
				{% else %}
					Buyer and Shipping Details
				{% endif %}
			</strong></h5>
			{{ get_address_html(invoice_data.BuyerDtls) }}

			{%- if diff_shipping_addr -%}
				<h5 style="margin-bottom: 5px;"><strong>Shipped To</strong></h5>
				{{ get_address_html(invoice_data.ShipDtls) }}
			{% endif %}
		</div>
	</div>
	{% if invoice_data.ItemList %}
	{% set item_list = get_non_zero_formatted_fields(data=invoice_data.ItemList) %}
	<div style="overflow-x: auto;">
		<h5 class="font-bold section-heading">3. Item Details</h5>
		<table class="table table-bordered hide-scrollbar">
			<thead>
				<tr>
					{% for key in item_list[0].keys() %}
					<th class="text-left">{{ key }}</th>
					{% endfor %}
				</tr>
			</thead>
			<tbody>
				{% for item in item_list %}
					<tr>
						{% for value in item.values() %}
							{% if value[0] == "â‚¹" %}
								<td class="text-right text-nowrap">{{ value }}</td>
							{% elif value is string %}
								<td class="text-left">{{ value }}</td>
							{% else %}
								<td class="text-center">{{ value }}</td>
							{% endif %}
						{% endfor %}
					</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	{% endif %}
	{% if invoice_data.ValDtls %}
	{%- set value_details = get_non_zero_formatted_fields(data=invoice_data.ValDtls)[0] -%}
	<div style="overflow-x: auto;">
		<h5 class="font-bold section-heading">4. Value Details</h5>
		<table class="table table-bordered hide-scrollbar">
			<thead>
				<tr>
					{% for key in value_details.keys() %}
					<th class="text-left">{{ key }}</th>
					{% endfor %}
				</tr>
			</thead>
			<tbody>
				<tr>
					{% for value in value_details.values() %}
						<td class="text-right text-nowrap">{{ value }}</td>
					{% endfor %}
				</tr>
			</tbody>
		</table>
	</div>
	{% endif %}
</div>
