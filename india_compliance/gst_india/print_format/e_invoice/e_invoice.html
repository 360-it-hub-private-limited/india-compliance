<style>
    {% include "india_compliance/gst_india/print_format/e_invoice/e_invoice.css" %}
</style>

{%- from "templates/print_formats/standard_macros.html" import add_header, render_field, print_value -%}

{% set e_invoice_log = frappe.db.get_value(
	"e-Invoice Log", doc.irn, ("invoice_data", "signed_qr_code"), as_dict=True
) %}

{%- set invoice_data = _dict(json.loads(e_invoice_log.invoice_data)) -%}

<div class="page-break">
	<div {% if print_settings.repeat_header_footer %} id="header-html" class="hidden-pdf" {% endif %}>
		{% if letter_head and not no_letterhead %}
			<div class="letter-head">{{ letter_head }}</div>
		{% endif %}
		<div class="print-heading text-right">
			<h2>e-Invoice<br><small>{{ doc.name }}</small></h2>
		</div>
	</div>
	{% if print_settings.repeat_header_footer %}
	<div id="footer-html" class="visible-pdf">
		{% if not no_letterhead and footer %}
		<div class="letter-head-footer">
			{{ footer }}
		</div>
		{% endif %}
		<p class="text-center small page-number visible-pdf">
			{{ _("Page {0} of {1}").format('<span class="page"></span>', '<span class="topage"></span>') }}
		</p>
	</div>
	{% endif %}
	<h5 class="font-bold section-heading">1. Transaction Details</h5>
	<div class="row section-break info-section">
		<div class="col-xs-8 column-break">
			<div class="row data-field">
				<div class="col-xs-4"><label>IRN</label></div>
				<div class="col-xs-8 value">{{ invoice_data.Irn }}</div>
			</div>
			<div class="row data-field">
				<div class="col-xs-4"><label>Ack. No</label></div>
				<div class="col-xs-8 value">{{ invoice_data.AckNo }}</div>
			</div>
			<div class="row data-field">
				<div class="col-xs-4"><label>Ack. Date</label></div>
				<div class="col-xs-8 value">{{ frappe.utils.format_datetime(invoice_data.AckDt, "dd/MM/yyyy hh:mm:ss") }}</div>
			</div>
			<div class="row data-field">
				<div class="col-xs-4"><label>Category</label></div>
				<div class="col-xs-8 value">{{ invoice_data.TranDtls.SupTyp }}</div>
			</div>
			<div class="row data-field">
				<div class="col-xs-4"><label>Document Type</label></div>
				<div class="col-xs-8 value">{{ invoice_data.DocDtls.Typ }}</div>
			</div>
			<div class="row data-field">
				<div class="col-xs-4"><label>Document No</label></div>
				<div class="col-xs-8 value">{{ invoice_data.DocDtls.No }}</div>
			</div>
		</div>
		<div class="col-xs-4 column-break">
			<img src="data:image/png;base64,{{ get_qr_code(e_invoice_log.signed_qr_code, scale=2) }}" width="175px" style="float: right;">
		</div>
	</div>
	<h5 class="font-bold section-heading">2. Party Details</h5>
	<div class="row section-break info-section">
		<div class="col-xs-6 column-break">
			{%- set dispatch_condition = invoice_data.DispDtls and (invoice_data.DispDtls.Pin != invoice_data.SellerDtls.Pin or invoice_data.DispDtls.Addr1 != invoice_data.SellerDtls.Addr1) -%}

			{% if invoice_data.SellerDtls %}
				{%- set seller = invoice_data.SellerDtls -%}
				<h5 style="margin-bottom: 5px;"><strong>
					{% if dispatch_condition %}
						Seller Details
					{% else %}
						Seller and Dispatch Details
					{% endif %}
				</strong></h5>
				<p>{{ seller.Gstin }}</p>
				<p>{{ seller.LglNm }}</p>
				<p>{{ seller.Addr1 }}</p>
				{%- if seller.Addr2 -%} <p>{{ seller.Addr2 }}</p> {% endif %}
				<p>{{ seller.Loc }}</p>
				{% set seller_gst_state = frappe.db.get_value("Address", doc.company_address, "gst_state") %}
				<p>{% if seller_gst_state %}{{ seller_gst_state }} - {% endif %}{{ seller.Pin }}</p>
			{% endif %}

			{%- if dispatch_condition -%}
				{%- set dispatch = invoice_data.DispDtls -%}
				<h5 style="margin-bottom: 5px;"><strong>Dispatched From</strong></h5>
				{%- if dispatch.Gstin -%} <p>{{ dispatch.Gstin }}</p> {% endif %}
				{% if  dispatch.Nm %}<p>{{ dispatch.Nm }}</p>{% endif %}
				<p>{{ dispatch.Addr1 }}</p>
				{%- if dispatch.Addr2 -%} <p>{{ dispatch.Addr2 }}</p> {% endif %}
				<p>{{ dispatch.Loc }}</p>
				{% set disp_gst_state = frappe.db.get_value("Address", doc.dispatch_address_name, "gst_state") %}
				<p>{% if disp_gst_state %}{{ disp_gst_state }} - {% elif seller_gst_state %} {{ seller_gst_state }} - {% endif %}{{ dispatch.Pin }}</p>
			{% endif %}
		</div>
		<div class="col-xs-6 column-break">
			{%- set shipping_condition = invoice_data.ShipDtls and (invoice_data.ShipDtls.Pin != invoice_data.BuyerDtls.Pin or invoice_data.ShipDtls.Addr1 != invoice_data.BuyerDtls.Addr1) -%}
			{% if invoice_data.BuyerDtls %}
				{%- set buyer = invoice_data.BuyerDtls -%}
				<h5 style="margin-bottom: 5px;"><strong>
					{% if shipping_condition %}
						Buyer Details
					{% else %}
						Buyer and Shipping Details
					{% endif %}
				</strong></h5>
				<p>{{ buyer.Gstin }}</p>
				<p>{{ buyer.LglNm }}</p>
				<p>{{ buyer.Addr1 }}</p>
				{%- if buyer.Addr2 -%} <p>{{ buyer.Addr2 }}</p> {% endif %}
				<p>{{ buyer.Loc }}</p>
				{% set cust_gst_state = frappe.db.get_value("Address", doc.customer_address, "gst_state") %}
				<p>{% if cust_gst_state %}{{ cust_gst_state }} - {% endif %}{{ buyer.Pin }}</p>
			{% endif %}


			{%- if shipping_condition -%}
				{%- set shipping = invoice_data.ShipDtls -%}
				<h5 style="margin-bottom: 5px;"><strong>Shipped To</strong></h5>
				<p>{{ shipping.Gstin }}</p>
				<p>{{ shipping.LglNm }}</p>
				<p>{{ shipping.Addr1 }}</p>
				{%- if shipping.Addr2 -%} <p>{{ shipping.Addr2 }}</p> {% endif %}
				<p>{{ shipping.Loc }}</p>
				{% set gst_state = frappe.db.get_value("Address", doc.shipping_address_name, "gst_state") %}
				<p>{% if gst_state %}{{ gst_state }} - {% endif %}{{ shipping.Pin }}</p>
			{% endif %}
		</div>
	</div>
	{% if invoice_data.ItemList %}
	{% set zero_amount_fields = get_zero_amount_fields(item_list=invoice_data.ItemList) %}
	<div style="overflow-x: auto;">
		<h5 class="font-bold section-heading">3. Item Details</h5>
		<table class="table table-bordered hide-scrollbar">
			<thead>
				<tr>
					<th class="text-left" style="width: 3%;">Sr. No.</th>
					<th class="text-left">Item</th>
					<th class="text-left" style="width: 10%;">HSN Code</th>
					{% if "Qty" not in zero_amount_fields %}
					<th class="text-left" style="width: 5%;">Qty</th>
					{% endif %}
					<th class="text-left" style="width: 5%;">UOM</th>
					{% if "UnitPrice" not in zero_amount_fields %}
					<th class="text-left">Rate</th>
					{% endif %}
					{% if "Discount" not in zero_amount_fields %}
					<th class="text-left" style="width: 5%;">Discount</th>
					{% endif %}
					{% if "AssAmt" not in zero_amount_fields %}
					<th class="text-left">Taxable Amount</th>
					{% endif %}
					{% if "GstRt" not in zero_amount_fields %}
					<th class="text-left" style="width: 7%;">Tax Rate</th>
					{% endif %}
					{% if not True %}
					<th class="text-left" style="width: 5%;">Other Charges</th>
					{% endif %}
					{% if "TotItemVal" in zero_amount_fields %}
					<th class="text-left">Total</th>
					{% endif %}
				</tr>
			</thead>
			<tbody>
				{% for item in invoice_data.ItemList %}
					<tr>
						<td class="text-left" style="width: 3%;">{{ item.SlNo }}</td>
						<td class="text-left">{{ item.PrdDesc }}</td>
						<td class="text-left" style="width: 10%;">{{ item.HsnCd }}</td>
						{% if "Qty" not in zero_amount_fields %}
						<td class="text-right" style="width: 5%;">{{ item.Qty }}</td>
						{% endif %}
						<td class="text-left" style="width: 5%;">{{ item.Unit }}</td>
						{% if "UnitPrice" not in zero_amount_fields %}
						<td class="text-right">{{ frappe.utils.fmt_money(item.UnitPrice, None, "INR") }}</td>
						{% endif %}
						{% if "Discount" not in zero_amount_fields %}
						<td class="text-right text-nowrap" style="width: 5%;">{{ frappe.utils.fmt_money(item.Discount, None, "INR") }}</td>
						{% endif %}
						{% if "AssAmt" not in zero_amount_fields %}
						<td class="text-right text-nowrap">{{ frappe.utils.fmt_money(item.AssAmt, None, "INR") }}</td>
						{% endif %}
						{% if "GstRt" not in zero_amount_fields or "CesRt" not in zero_amount_fields %}
						<td class="text-right text-nowrap" style="width: 7%;">{{ item.GstRt + item.CesRt }} %</td>
						{% endif %}
						{% if not True %}
						<td class="text-right text-nowrap" style="width: 5%;">{{ frappe.utils.fmt_money(0, None, "INR") }}</td>
						{% endif %}
						{% if "TotItemVal" in zero_amount_fields %}
						<td class="text-right text-nowrap">{{ frappe.utils.fmt_money(item.TotItemVal, None, "INR") }}</td>
						{% endif %}
					</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	{% endif %}
	{% if invoice_data.ValDtls %}
	{%- set value_details = invoice_data.ValDtls -%}
	<div style="overflow-x: auto;">
		<h5 class="font-bold section-heading">4. Value Details</h5>
		<table class="table table-bordered hide-scrollbar">
			<thead>
				<tr>
					<th class="text-left">Taxable Amount</th>
					{% if value_details.CgstVal > 0 %}
					<th class="text-left">CGST</th>
					{% endif %}
					{% if value_details.SgstVal > 0 %}
					<th class="text-left">SGST</th>
					{% endif %}
					{% if value_details.IgstVal > 0 %}
					<th class="text-left">IGST</th>
					{% endif %}
					{% if value_details.CesVal > 0 %}
					<th class="text-left">CESS</th>
					{% endif %}
					{% if value_details.Discount > 0 %}
					<th class="text-left">Discount</th>
					{% endif %}
					{% if value_details.OthChrg > 0 %}
					<th class="text-left" style="width: 10%;">Other Charges</th>
					{% endif %}
					{% if value_details.RndOffAmt != 0 %}
					<th class="text-left" style="width: 10%;">Round Off</th>
					{% endif %}
					{% if value_details.TotInvVal > 0 %}
					<th class="text-left">Total Value</th>
					{% endif %}
				</tr>
			</thead>
			<tbody>
				<tr>
					<td class="text-right text-nowrap">{{ frappe.utils.fmt_money(value_details.AssVal, None, "INR") }}</td>
					{% if value_details.CgstVal > 0 %}
					<td class="text-right text-nowrap">{{ frappe.utils.fmt_money(value_details.CgstVal, None, "INR") }}</td>
					{% endif %}
					{% if value_details.SgstVal > 0 %}
					<td class="text-right text-nowrap">{{ frappe.utils.fmt_money(value_details.SgstVal, None, "INR") }}</td>
					{% endif %}
					{% if value_details.IgstVal > 0 %}
					<td class="text-right text-nowrap">{{ frappe.utils.fmt_money(value_details.IgstVal, None, "INR") }}</td>
					{% endif %}
					{% if value_details.CesVal > 0 %}
					<td class="text-right text-nowrap">{{ frappe.utils.fmt_money(value_details.CesVal, None, "INR") }}</td>
					{% endif %}
					{% if value_details.Discount > 0 %}
					<td class="text-right text-nowrap">{{ frappe.utils.fmt_money(value_details.Discount, None, "INR") }}</td>
					{% endif %}
					{% if value_details.OthChrg > 0 %}
					<td class="text-right text-nowrap">{{ frappe.utils.fmt_money(value_details.OthChrg, None, "INR") }}</td>
					{% endif %}
					{% if value_details.RndOffAmt != 0 %}
					<td class="text-right text-nowrap">{{ frappe.utils.fmt_money(value_details.RndOffAmt, None, "INR") }}</td>
					{% endif %}
					{% if value_details.TotInvVal > 0 %}
					<td class="text-right text-nowrap">{{ frappe.utils.fmt_money(value_details.TotInvVal, None, "INR") }}</td>
					{% endif %}
				</tr>
			</tbody>
		</table>
	</div>
	{% endif %}
</div>
